---
title: 分布式架构学习笔记
date: 2024-3-11 10:57:00
tags: [计算机网络,学习笔记,分布式,微服务]
category: 系统设计
---

### 前言

时至今日单体架构已经是大多数开发者都实践过的一种软件架构，对于小型系统来说单台机器就足以良好运行，但对于工程师来说“大型单体系统”无疑是一个地狱：不可拓展，难以扩展，复杂逻辑难以调试，代码冲突让工程师们深陷其中。

如今流行的是“分布式系统”，“微服务”，“云原生”，“生成式AI”等新技术，这些技术随着时间的推移愈发成熟和稳定。想象之中，微服务架构对于程序员来说应该是友善的，你可以在这个架构体系下选择合适的技术栈，熟悉什么框架就使用什么框架。但是对于整个项目设计来说是复杂的，必然会面临“注册发现”，“负载均衡”，“熔断/降级”，“故障隔离”，“认证授权”，“通信传输”，“扩容”…… 等等问题。

Kubernetes 可能是解决上述问题的一个方案，“云原生”标准让更多的应用天生适合在云端部署，让无数工程师们趋之若鹜。Etcd 解决了注册发现的麻烦，容器化技术解决了故障隔离/扩容，“服务网格”不仅接管了应用所有对外通信，也对数据平面内的通信进行管理，无论是负载均衡还是通信传输，亦或者是熔断降级等。

笔者是从单体应用直接跨度到微服务架构应用的开发者，对于分布式架构系统一直存在疑虑，不得不承认对于分布式架构及微服务架构一直都没有一个系统的了解及分析，借此机会重新梳理。



### 远程服务调用

远程服务调用(Remote Procedure Call，RPC)，它存在的最初目的是**为了让计算机能跟调用本地方法一样去调用远程方法**。单体应用无需考虑这个问题，对于单体应用来说它本来就在同一进程内进行通信，而对于拆分若干个服务的分布式应用来说，首选要解决的是：要通过什么办法来互相交换服务之间的信息。

现阶段已经出现了很多不同偏重RPC：

```
朝着面向对象发展，不满足于 RPC 将面向过程的编码方式带到分布式，希望在分布式系统中也能够进行跨进程的面向对象编程，代表为 RMI、.NET Remoting

朝着性能发展，代表为grpc和Thrift

朝着简化发展，代表为JSON-RPC，牺牲了功能和效率换来协议的简单轻便，接口与格式都更为通用，适合web浏览器。

聚焦提供核心，更高层次的能力，比如负载均衡，服务注册，可观察性等方面的支持。这一类框架代表有Thrift和Dubbo。
```



### REST 设计风格

REST和RPC应该是两个不同纬度的东西，REST不是某一种远程服务调用的协议，它本质来说只是一个风格，它不像HTTP1.1或RPC那样拥有规范或协议。但是如果理解HTTP就会发现，REST可以说是进一步的抽象。

REST提出以资源为主体进行服务设计的风格，这和RPC不同，PRC需要你知道远程服务上有哪些方法可提供调用，REST对资源的标准操作直接映射到标准的HTTP方法上去了，这极大的降低了设计门槛，不需要刻意学习什么。

由于REST绑定HTTP，他在设计接口时就很符合工程师的直觉，有经验的工程师在不需要专门阅读接口说明书，也能推断出标准的REST接口。

RPC和REST 一直相提并论，但是它们本质不同，对于架构师来说需权衡的是需求的场景，看哪种远程调用方式更适合整体的应用。





### 事务处理

事务处理是分布式系统不可缺少的一部分，它的存在就是为了保证系统中所有的数据都是符合工程师预期的，即数据保持**一致性(Consistency)。**

所谓ACID：

原子性(Atomic)：事务保证对多个数据修改时，要么同时成功，要么同时失败。

隔离性(Isolation): 在不同的业务处理过程中，事务保证各自正在读写的数据相互独立，不会彼此影响。

持久性(Durability): 事务应该保证所有成功被提交的数据修改都能正确的被持久化，不丢失数据。

当一个服务只使用一个数据源时，获得一致性是相对容易的。因为多个并发的事务在读写时能感到是否存在冲突，并发事务的读写在时间线上的最终顺序是由数据源来确定的，这种事务间的一致性被称为“内部一致性”。

当使用多个数据源时，问题就会被放大多倍，不同服务并发执行多个不同数据源时，这些数据源可能在不同的机房，不同的城市，甚至不同的国家。确定时间顺序不由任何一个数据源来确定，在这种情况下“网络是不可信的”，“时钟是不可靠的”，“复制可能会延迟”，“部分数据可能会失效”……

解决上述问题会付出很大的代价，但是确实是分布式系统中必然会遇到的问题，所以对于架构师来说，在确保代价可承受的前提下尽可能保持一个较高的一致性保证。



